services:
  dev:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
        UNAME: ${UNAME:-vscode}
        GNAME: ${GNAME:-vscode}
    volumes:
      # hagevvashi.info-dev-hub リポジトリ全体をバインドマウント
      - type: bind
        source: ..
        target: /home/${UNAME:-vscode}/${REPO_NAME:-dev-hub}
        consistency: cached
      # repos/ を Docker Volume で直接マウント（I/Oパフォーマンス）
      - type: volume
        source: repos
        target: /home/${UNAME:-vscode}/${REPO_NAME:-dev-hub}/repos
      # /var/run/docker.sock をマウント ― Docker from Docker のための設定
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock
    working_dir: /home/${UNAME:-vscode}/${REPO_NAME:-dev-hub}
    ports:
      - "4035:4035"
      - "8035:8035"
      - "9001:9001"
      - "8080:8080"
    
    tty: true
    stdin_open: true

    tmpfs:
      - /run:exec
      - /run/lock
      - /tmp

    environment:
      - DEBUG_MODE=false  # true にするとデバッグモード
      - UNAME=${UNAME:-vscode}
      - REPO_NAME=${REPO_NAME:-dev-hub}
      - GNAME=${GNAME:-vscode}

    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # Healthcheck: supervisord の動作状態を監視
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    healthcheck:
      test: |
        if [ "$DEBUG_MODE" = "true" ]; then
          # DEBUG_MODE 時はヘルスチェックをパス（常に healthy）
          exit 0
        else
          # 通常モード: supervisorctl で code-server の状態を確認
          supervisorctl status code-server | grep -q RUNNING || exit 1
        fi
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

volumes:
  repos:
    external: true
