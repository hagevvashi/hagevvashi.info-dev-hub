FROM debian:12.7

ARG GID
ARG GNAME
ARG UID
ARG UNAME
ARG TARGETARCH

# ãƒ­ãƒ¼ã‚«ãƒ«ã®debian.sourcesãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸å†…ã«ã‚³ãƒ”ãƒ¼
COPY .devcontainer/debian.sources /etc/apt/sources.list.d/debian.sources

# # sbt ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®ãŸã‚ã«å…¬å¼ãƒ¬ãƒã‚¸ãƒˆãƒªã‚’è¿½åŠ ã—ãŸã‚Š
# RUN echo "deb https://repo.scala-sbt.org/scalasbt/debian all main" | tee /etc/apt/sources.list.d/sbt.list && \
#     echo "deb https://repo.scala-sbt.org/scalasbt/debian /" | tee /etc/apt/sources.list.d/sbt_old.list && \
#     curl -sL "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x99E82A75642AC823" | apt-key add && \
#     apt-get update && \
#     apt-get install -y sbt

# Step 1: Install prerequisites for adding apt repositories
RUN apt-get update \
    && apt-get install --no-install-recommends -y \
      curl \
      gnupg2 \
      lsb-release \
      ca-certificates \
      locales \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Configure locales for Japanese support
RUN echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen \
    && echo "ja_JP.UTF-8 UTF-8" >> /etc/locale.gen \
    && locale-gen

# Set locale environment variables
ENV LANG=en_US.UTF-8 \
    LANGUAGE=en_US:en \
    LC_CTYPE=ja_JP.UTF-8

# Set timezone
ENV TZ=Asia/Tokyo

# Step 2: Add Docker, GitHub CLI, and Google Cloud SDK repositories
RUN curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null \
    && curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | gpg --dearmor -o /usr/share/keyrings/google-cloud.gpg \
    && echo "deb [signed-by=/usr/share/keyrings/google-cloud.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | tee /etc/apt/sources.list.d/google-cloud-sdk.list > /dev/null

    # Step 3: Install main packages and perform setup
RUN apt-get update \
    && apt-get install --no-install-recommends -y \
      # CLI for Docker, GitHub, and Google Cloud
      docker-ce-cli gh google-cloud-cli \
      # Certificate utils
      libnss3-tools \
      # Network utils
      iputils-ping net-tools openssh-client lsof \
      # jq
      jq \
      # Python
      python3 pipx \
      # Git
      git git-lfs \
      # Sudo
      sudo \
      # Editors and viewers
      vim \
      less \
      # Basic tools
      procps \
      grep sed which tree \
      # Timezone data
      tzdata \
      # Archive tools
      zip unzip xz-utils \
      # peco
      peco \
      # redis
      redis-tools \
      # Process management: supervisord (PID 1)
      supervisor \
    # Clean up apt
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# s6-overlay: PID 1 ä¿è­·ãƒ»ãƒ—ãƒ­ã‚»ã‚¹ç›£è¦–
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ARG S6_OVERLAY_VERSION=3.1.6.2
ADD https://github.com/just-containers/s6-overlay/releases/download/v${S6_OVERLAY_VERSION}/s6-overlay-noarch.tar.xz /tmp
RUN tar -C / -Jxpf /tmp/s6-overlay-noarch.tar.xz && \
    rm /tmp/s6-overlay-noarch.tar.xz

# ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ¥ã®ãƒã‚¤ãƒŠãƒª
RUN ARCH=$(case "${TARGETARCH}" in \
        "amd64") echo "x86_64" ;; \
        "arm64") echo "aarch64" ;; \
        *) echo "x86_64" ;; \
    esac) && \
    curl -L "https://github.com/just-containers/s6-overlay/releases/download/v${S6_OVERLAY_VERSION}/s6-overlay-${ARCH}.tar.xz" \
    -o /tmp/s6-overlay-arch.tar.xz && \
    tar -C / -Jxpf /tmp/s6-overlay-arch.tar.xz && \
    rm /tmp/s6-overlay-arch.tar.xz

# /etc/s6-rc ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ—©æœŸã«ä½œæˆ
RUN mkdir -p /etc/s6-rc

# s6-rc ã‚µãƒ¼ãƒ“ã‚¹å®šç¾©ã‚’ã‚³ãƒ”ãƒ¼
# v10è¨­è¨ˆ: supervisord, process-compose, docker-entrypoint ã‚’ s6-overlay ã§ç®¡ç†
COPY .devcontainer/s6-rc.d/ /etc/s6-overlay/s6-rc.d/

# s6-rc ã‚µãƒ¼ãƒ“ã‚¹ã® run ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸
# æ³¨è¨˜: COPY å‘½ä»¤ã¯æ¨©é™ã‚’ä¿æŒã™ã‚‹ã¯ãšã ãŒã€æ˜ç¤ºçš„ã«è¨­å®šã™ã‚‹ã“ã¨ã§ç¢ºå®Ÿæ€§ã‚’é«˜ã‚ã‚‹
RUN find /etc/s6-overlay/s6-rc.d -type f -name 'run' -exec chmod +x {} \;

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Process management: supervisord
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ã‚³ãƒ”ãƒ¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
COPY .devcontainer/supervisord/seed.conf /etc/supervisor/seed.conf

# â˜…â˜…â˜… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆå‰ã«æ¤œè¨¼ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŸã‚ã€ã“ã“ã§ã¯å®Ÿè¡Œã—ãªã„ â˜…â˜…â˜…
# RUN echo "ğŸ” Validating default supervisord configuration..." && \
#     supervisord -c /etc/supervisor/seed.conf -t && \
#     echo "âœ… Default supervisord configuration is valid"

# Create python symlink
RUN ln -s $(which python3) /usr/bin/python

# Atuinã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰
RUN curl --proto '=https' --tlsv1.2 -LsSf https://setup.atuin.sh | sh && \
    # ãƒã‚¤ãƒŠãƒªã‚’ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã«ç§»å‹•
    mv /root/.atuin/bin/atuin /usr/local/bin/ && \
    chmod +x /usr/local/bin/atuin && \
    # rootã®Atuinãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    rm -rf /root/.atuin

# Atuin init for interactive shells is configured in ~/.bashrc below


# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Process management: process-compose
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# Install process-compose
ARG PROCESS_COMPOSE_VERSION=1.85.0
RUN ARCH=$(case "${TARGETARCH}" in \
        "amd64") echo "amd64" ;; \
        "arm64") echo "arm64" ;; \
        *) echo "amd64" ;; \
    esac) && \
    curl -L "https://github.com/F1bonacc1/process-compose/releases/download/v${PROCESS_COMPOSE_VERSION}/process-compose_linux_${ARCH}.tar.gz" \
    -o /tmp/process-compose.tar.gz && \
    tar -xzf /tmp/process-compose.tar.gz -C /usr/local/bin && \
    chmod +x /usr/local/bin/process-compose && \
    rm /tmp/process-compose.tar.gz

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ã‚³ãƒ”ãƒ¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
RUN mkdir -p /etc/process-compose
COPY .devcontainer/process-compose/seed.yaml /etc/process-compose/seed.yaml

# Install code-server
RUN curl -fsSL https://code-server.dev/install.sh | sh

# DuckDBã¨xsvãƒã‚¤ãƒŠãƒªã‚’ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# DuckDB CLI ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ /usr/local/bin ã«é…ç½®
RUN DUCKDB_ARCH=$(case "${TARGETARCH}" in \
        "amd64") echo "amd64" ;; \
        "arm64") echo "aarch64" ;; \
        *) echo "amd64" ;; \
    esac) && \
    curl -L -o /tmp/duckdb.zip https://github.com/duckdb/duckdb/releases/download/v1.0.0/duckdb_cli-linux-${DUCKDB_ARCH}.zip && \
    cd /tmp && unzip duckdb.zip && \
    mv duckdb /usr/local/bin/ && \
    chmod +x /usr/local/bin/duckdb && \
    rm -f /tmp/duckdb.zip && \
    # xsv ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ /usr/local/bin ã«é…ç½® (amd64 ã®ã¿)
    if [ "${TARGETARCH}" = "amd64" ]; then \
        curl -L -o /tmp/xsv.tar.gz https://github.com/BurntSushi/xsv/releases/download/0.13.0/xsv-0.13.0-x86_64-unknown-linux-musl.tar.gz && \
        cd /tmp && tar -zxf xsv.tar.gz && \
        mv xsv /usr/local/bin/ && \
        chmod +x /usr/local/bin/xsv && \
        rm -f /tmp/xsv.tar.gz; \
    fi

#  å¤–éƒ¨åŒ–ã—ãŸã‚·ã‚§ãƒ«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«ã‚³ãƒ”ãƒ¼
# ã“ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã€ã‚³ãƒ”ãƒ¼å…ƒã®ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã«ã®ã¿ç„¡åŠ¹åŒ–ã•ã‚Œã‚‹
COPY .devcontainer/shell/.bash_profile /etc/skel/.bash_profile
COPY .devcontainer/shell/.bashrc_custom /etc/skel/.bashrc_custom
COPY .devcontainer/shell/paths.sh /etc/skel/paths.sh
COPY .devcontainer/shell/env.sh /etc/skel/env.sh
COPY .devcontainer/shell/.profile /etc/skel/.profile
# ä»–ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°ã“ã“ã«è¿½åŠ  (e.g. aliases.sh)
# COPY.devcontainer/shell/aliases.sh /etc/skel/.aliases.sh

#  ãƒ¡ã‚¤ãƒ³ã®.bashrcã‹ã‚‰ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã‚’èª­ã¿è¾¼ã‚€ã‚ˆã†ã«è¨­å®š
# ã“ã®RUNå‘½ä»¤ã¯é™çš„ãªæ–‡å­—åˆ—ã‚’è¿½è¨˜ã™ã‚‹ã ã‘ãªã®ã§ã€
# ç›´å‰ã®COPYãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ã‚‹é™ã‚Šã€ã“ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹
RUN echo '\n# Load custom dev container configurations' >> /etc/skel/.bashrc && \
    echo '# First, load environment variables' >> /etc/skel/.bashrc && \
    echo 'if [ -f ~/env.sh ]; then . ~/env.sh; fi' >> /etc/skel/.bashrc && \
    echo '# Second, set up paths' >> /etc/skel/.bashrc && \
    echo 'if [ -f ~/paths.sh ]; then . ~/paths.sh; fi' >> /etc/skel/.bashrc && \
    echo '\n# Then, load custom functions and aliases' >> /etc/skel/.bashrc && \
    echo 'if [ -f ~/.bashrc_custom ]; then . ~/.bashrc_custom; fi' >> /etc/skel/.bashrc
    # echo 'if [ -f ~/.aliases.sh ]; then. ~/.aliases.sh; fi' >> /etc/skel/.bashrc

# root ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã«ã‚‚åŒæ§˜ã®è¨­å®šã‚’é©ç”¨
# æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆrootï¼‰ã«ã¯ /etc/skel/ ã®å†…å®¹ãŒè‡ªå‹•ã‚³ãƒ”ãƒ¼ã•ã‚Œãªã„ãŸã‚ã€æ˜ç¤ºçš„ã«ã‚³ãƒ”ãƒ¼
# /etc/skel/.bashrc ã«ã¯æ—¢ã«ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã®èª­ã¿è¾¼ã¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ã™ã‚‹ã ã‘ã§è‰¯ã„
RUN cp /etc/skel/.bashrc_custom /root/.bashrc_custom && \
    cp /etc/skel/paths.sh /root/paths.sh && \
    cp /etc/skel/env.sh /root/env.sh && \
    cp /etc/skel/.bashrc /root/.bashrc

# User and group setup
    # Create docker group
RUN groupadd -g 999 docker
RUN if ! getent group ${GNAME} > /dev/null 2>&1; then \
        groupadd -o -g ${GID} ${GNAME}; \
    fi
RUN useradd -o -l -u ${UID} -g ${GNAME} -G docker -m ${UNAME}
RUN chown ${UNAME}:${GNAME} /home/${UNAME}
RUN mkdir -p /home/${UNAME}/repos
RUN chown -R ${UID}:${GID} /home/${UNAME}/repos
RUN echo "${UNAME} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# â˜…â˜…â˜… supervisordæ¤œè¨¼ã«ã¤ã„ã¦ â˜…â˜…â˜…
# ãƒ“ãƒ«ãƒ‰æ™‚ã« `supervisord -t` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€å®Ÿéš›ã«supervisordãŒèµ·å‹•ã—ã¦
# ãƒ—ãƒ­ã‚»ã‚¹ã‚’spawnã™ã‚‹ãŸã‚ã€ãƒ“ãƒ«ãƒ‰ãŒãƒãƒ³ã‚°ã™ã‚‹å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ã€‚
# seed.confã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®æœ€å°é™è¨­å®šã§ã‚ã‚Šã€é »ç¹ã«å¤‰æ›´ã•ã‚Œãªã„ãŸã‚ã€
# å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼ã«ä»»ã›ã‚‹æ–¹é‡ã¨ã™ã‚‹ã€‚
# è©³ç´°: initiatives/20251229--dev-hub-concept/25_4_3_docker_build_debug_log.md Part 3

COPY .devcontainer/supervisord/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
USER ${UNAME}
WORKDIR /home/${UNAME}

# Ensure bash-preexec is available for Atuin bash integration
RUN curl -fsSL https://raw.githubusercontent.com/rcaloras/bash-preexec/master/bash-preexec.sh -o ~/.bash_preexec

# tfenv ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN git clone https://github.com/tfutils/tfenv.git ~/.tfenv && \
    # tfenv ã§ terraform 1.13.0 ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    ~/.tfenv/bin/tfenv install 1.13.0 && \
    ~/.tfenv/bin/tfenv use 1.13.0

# pipx ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã« & websshã€CSVãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN pipx ensurepath && \
    pipx install webssh && \
    pipx install csvkit && \
    pipx install visidata

# sdkman ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN curl -s 'https://get.sdkman.io' | bash && \
    bash -c "source ~/.sdkman/bin/sdkman-init.sh && sdk install java 11.0.26-tem && sdk use java 11.0.26-tem && sdk default java 11.0.26-tem"
    # # cmak 3.0.0.6 ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    # && rm -rf cmak && curl -sL https://github.com/yahoo/CMAK/releases/download/3.0.0.6/cmak-3.0.0.6.zip -o cmak.zip && unzip -o cmak.zip && rm cmak.zip && mv cmak-3.0.0.6 cmak

# asdf install
RUN git clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.13.1

ENV PATH="/home/${UNAME}/.asdf/bin:/home/${UNAME}/.asdf/shims:${PATH}"

# Node.jsãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN asdf plugin add nodejs https://github.com/asdf-vm/asdf-nodejs.git && \
    # Node.js ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    asdf install nodejs 22.17.0 && \
    asdf install nodejs 24.9.0 && \
    asdf global nodejs 22.17.0 && \
    corepack enable npm && \
    # corepack ã§ npm ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å›ºå®š
    npm -v && \
    npm install -g @anthropic-ai/claude-code && \
    npm install -g @google/gemini-cli && \
    npm install -g difit && \
    npm install -g dotenv-cli

# ENTRYPOINT ã¯éã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚·ã‚§ãƒ«ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã€é€šå¸¸ã¯ã‚·ã‚§ãƒ«ã®åˆæœŸåŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ãªã„
# ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ­ã‚°ã‚¤ãƒ³ã‚·ã‚§ãƒ«ã§ bash ã‚’ç”¨ã„ã¦ bash ã‚·ã‚§ãƒ«ã‚’æ‰‹å‹•ã§å®Ÿè¡Œã—ãŸã¨ãã¨ã¯ç•°ãªã‚‹ç’°å¢ƒã«ãªã‚‹
# ãã®ãŸã‚ã€ JAVA_HOME ã‚„ PATH ãŒ .bashrc ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã‚Œã‚‰ã®è¨­å®šãŒèª­ã¿è¾¼ã¾ã‚Œãªã„
# ãã®ãŸã‚ã€ ENTRYPOINT ã§ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹
ENV JAVA_HOME=/home/${UNAME}/.sdkman/candidates/java/current
ENV PATH=$JAVA_HOME/bin:$PATH
# WORKDIR /home/${UNAME}/cmak
# code-serverã®ãƒãƒ¼ãƒˆè¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 4035ï¼‰
ENV CODE_SERVER_PORT=4035
ENV DIFIT_PORT=8035
ENV SUPERVISORD_PORT=9001
ENV PROCESS_COMPOSE_PORT=8080
EXPOSE $DIFIT_PORT $CODE_SERVER_PORT $SUPERVISORD_PORT $PROCESS_COMPOSE_PORT

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Entrypoint & CMD
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

USER root
# ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆå‰ã«å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å®Ÿè¡Œã™ã‚‹
# ENTRYPOINTã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼
COPY .devcontainer/docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ç”¨ENTRYPOINTã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼
COPY .devcontainer/debug-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/debug-entrypoint.sh

# ENTRYPOINTã‚’æœ€å¾Œã«è¨­å®šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆå¾Œï¼‰
# ã“ã‚Œã«ã‚ˆã‚Šã€ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ <ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼> ã«ãªã‚‹
ENTRYPOINT ["/init"]
# s6-overlay ã‚’ PID 1 ã¨ã—ã¦èµ·å‹•ï¼ˆ/initï¼‰
# v10è¨­è¨ˆ: s6-overlay ãŒä»¥ä¸‹ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç®¡ç†
#   - docker-entrypoint (oneshot): åˆæœŸåŒ–å‡¦ç†ï¼ˆPhase 1-5ï¼‰
#   - supervisord (longrun): code-serverç­‰ã®ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†
#   - process-compose (longrun): TUIãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†

# ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
# USER ${UNAME}
# WORKDIR /home/${UNAME}
