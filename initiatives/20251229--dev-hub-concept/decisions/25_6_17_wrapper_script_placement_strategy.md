# ラッパースクリプト配置場所の戦略: v11ディレクトリ構造との整合性

**作成日**: 2026-01-10
**目的**: `bin/dc` ラッパースクリプトの配置場所をv11ディレクトリ構造に整合させる戦略を立案する

**関連ドキュメント**:
- `14_詳細設計_ディレクトリ構成.v11.md` - v11ディレクトリ構造定義
- `25_6_16_wrapper_script_strategy.md` - ラッパースクリプト戦略
- `25_6_12_v10_completion_implementation_tracker.md` - 実装トラッカー

---

## 0. 目標

**達成すべきKPI**:
1. v10実装完了（PID 1=root、docker exec=${UNAME}の両立）
2. v11ディレクトリ構造との完全な整合性
3. チーム全体で運用可能なラッパースクリプト配置

**スプリント/Qのゴール**:
- v10設計完成とUSER問題解決の完了
- アーキテクチャの一貫性維持

---

## 1. 課題（目標とのギャップ）

### 1.1 現状の問題

**25_6_16で提案した配置場所**: `bin/dc`

**v11構造との不整合**:
```text
# v11で定義されている構造（14_詳細設計_ディレクトリ構成.v11.md より）
${project}-dev-hub/
├── .devcontainer/
├── foundations/
├── initiatives/
├── members/
├── workloads/          # v11で追加
├── repos/
├── workspace.code-workspace
├── .gitignore
└── .env.example
```

**問題点**:
- ❌ v11構造に `bin/` ディレクトリが存在しない
- ❌ 25_6_16で `bin/dc` を提案したが、アーキテクチャ定義と矛盾
- ❌ 実装前にv11構造との整合性を確保する必要がある

### 1.2 ギャップの詳細

| 項目 | 現状（25_6_16提案） | あるべき姿（v11準拠） |
|------|-------------------|---------------------|
| スクリプト配置 | `bin/dc`（v11未定義） | v11構造で定義された場所 |
| 構造整合性 | ❌ v11と不整合 | ✅ v11完全準拠 |
| ADR記録 | なし | 必要（構造変更の場合） |

---

## 2. 原因

### 2.1 根本原因

1. **25_6_16立案時にv11構造を参照しなかった**
   - ラッパースクリプト実装に集中し、ディレクトリ構造の確認を怠った
   - `bin/` は一般的な慣習だが、v11で意図的に除外されている可能性

2. **v11構造の設計意図が不明**
   - なぜ `bin/` が含まれていないのか
   - 開発ツールスクリプトをどこに配置すべきか、v11で明示されていない

### 2.2 ユーザーの指摘

> bin/dc ってどこのディレクトリですか？
> initiatives/20251229--dev-hub-concept/14_詳細設計_ディレクトリ構成.v11.md
> ちゃんとこれにアラインしてますか？

**ユーザーの懸念**:
- アーキテクチャの一貫性を重視
- v11構造は基盤設計の一部であり、軽率に変更すべきでない

---

## 3. 目的（あるべき状態）

### 3.1 技術的要件

1. **v11構造との完全な整合性**
   - 既存のv11構造に適合、または
   - v11構造を更新し、ADRで記録

2. **ラッパースクリプトの機能要件**（25_6_16より）
   - docker compose exec に自動的に -u ${UNAME} を付与
   - リポジトリルートから相対パスで実行可能
   - チーム全体でGit管理されバージョン管理可能

3. **保守性・拡張性**
   - 発見しやすい場所
   - 将来的な開発ツール追加を考慮
   - ドキュメント性の高い配置

### 3.2 ステークホルダーの期待

- **開発者**: 使いやすく、覚えやすい場所
- **アーキテクト（ユーザー）**: v11構造との整合性、ADRによる記録
- **チーム**: 一貫性のある構造、明確なドキュメント

---

## 4. 戦略・アプローチ（解決の方針）

### 4.1 基本方針

**「v11構造を尊重し、必要最小限の変更で整合性を確保する」**

### 4.2 評価基準

解決策を以下の観点で評価:

1. **v11構造との整合性** - 既存構造への影響
2. **技術的正当性** - スクリプト配置場所の妥当性
3. **将来の拡張性** - 他の開発ツール追加時の柔軟性
4. **発見しやすさ** - チームメンバーが見つけやすいか
5. **保守コスト** - ドキュメント更新、ADR作成の必要性

**重要**: 「変更量が少ない」「シンプル」という理由だけで選択しない

---

## 5. 解決策

### 解決策1: `.devcontainer/dc` に配置（v11構造変更なし）

**配置場所**: `.devcontainer/dc`

**実装**:
```bash
# スクリプト配置
.devcontainer/dc

# スクリプト内の相対パス計算（修正版）
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEVCONTAINER_DIR="${SCRIPT_DIR}"  # 既に .devcontainer 内にいる
```

**使用方法**:
```bash
# リポジトリルートから
./.devcontainer/dc exec dev /bin/bash
```

**メリット**:
1. ✅ **v11構造変更不要** - 既存の `.devcontainer/` ディレクトリを活用
2. ✅ **文脈的に適切** - DevContainer操作ツールとして明確な位置付け
3. ✅ **構造の一貫性** - 他のDevContainer関連スクリプト（host-setup.sh、post-create.sh）と同じ場所
4. ✅ **ADR不要** - v11構造を変更しないため、アーキテクチャ判断が不要
5. ✅ **Git管理** - `.devcontainer/` は既にGit管理対象

**デメリット**:
1. ⚠️ **パスがやや長い** - `./.devcontainer/dc` （14文字）
2. ⚠️ **発見しにくい可能性** - `.devcontainer/` 内を探す必要
3. ⚠️ **開発ツールの混在** - DevContainerビルド用スクリプトと運用スクリプトが同じ場所

**v11構造への影響**:
- **影響なし** - 既存構造の範囲内

**将来の拡張性**:
- 他の運用スクリプト追加時も `.devcontainer/` 内に配置
- `.devcontainer/` が肥大化する可能性

---

### 解決策2: `bin/` ディレクトリを新設（v11構造更新）

**配置場所**: `bin/dc`

**v11構造の更新**:
```text
${project}-dev-hub/
├── .devcontainer/
├── bin/                    # ★新設: 開発ツールスクリプト
│   └── dc
├── foundations/
├── initiatives/
├── members/
├── workloads/
├── repos/
├── workspace.code-workspace
├── .gitignore
└── .env.example
```

**実装**:
```bash
# スクリプト配置
bin/dc

# スクリプト内の相対パス計算（元のまま）
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEVCONTAINER_DIR="${SCRIPT_DIR}/../.devcontainer"
```

**使用方法**:
```bash
# リポジトリルートから
./bin/dc exec dev /bin/bash
```

**メリット**:
1. ✅ **一般的な慣習に準拠** - `bin/` は開発ツール用の標準的なディレクトリ名
2. ✅ **発見しやすい** - リポジトリルートに配置、パスが短い（`./bin/dc` = 8文字）
3. ✅ **将来の拡張性** - 他の開発ツールも `bin/` に統一的に配置可能
4. ✅ **役割の明確化** - DevContainerビルド用（`.devcontainer/`）と運用スクリプト（`bin/`）を分離

**デメリット**:
1. ❌ **v11構造変更が必要** - `bin/` ディレクトリを追加
2. ❌ **ADR作成が必要** - アーキテクチャ変更のため、Architecture Decision Recordで記録
3. ❌ **複数ドキュメント更新** - v11構造ドキュメント、実装トラッカー等

**v11構造への影響**:
- **新規ディレクトリ追加** - `bin/` を第一級ディレクトリとして定義
- **ADR 005（仮）**: 「開発ツールスクリプトの配置場所」

**将来の拡張性**:
- ✅ 他の運用ツール（例: `bin/test-runner`, `bin/deploy`）を統一的に管理
- ✅ `.devcontainer/` はビルド用、`bin/` は運用用という明確な役割分担

---

### 解決策3: `workloads/scripts/` 配下に配置（v11構造拡張）

**配置場所**: `workloads/scripts/dc`

**v11構造の拡張**:
```text
workloads/
├── supervisord/
│   ├── project.conf
│   └── README.md
├── process-compose/
│   ├── project.yaml
│   └── README.md
└── scripts/                # ★新設: 運用スクリプト
    ├── dc
    └── README.md
```

**実装**:
```bash
# スクリプト配置
workloads/scripts/dc

# スクリプト内の相対パス計算（修正版）
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEVCONTAINER_DIR="${SCRIPT_DIR}/../../.devcontainer"
```

**使用方法**:
```bash
# リポジトリルートから
./workloads/scripts/dc exec dev /bin/bash
```

**メリット**:
1. ✅ **v11の `workloads/` 概念に整合** - 「実運用プロセス管理設定」の一部として位置付け
2. ✅ **運用ツールの集約** - supervisord、process-composeと同じ `workloads/` 配下
3. ✅ **文脈的に適切** - 「実運用」のためのスクリプト

**デメリット**:
1. ❌ **パスが非常に長い** - `./workloads/scripts/dc` （22文字）
2. ❌ **`workloads/` の設計意図と若干ズレ** - v11では「プロセス管理設定」であり、「スクリプト」ではない
3. ❌ **発見しにくい** - `workloads/` 内を探す必要
4. ❌ **ADR更新が必要** - ADR 004（workloads命名根拠）の更新

**v11構造への影響**:
- **`workloads/` の役割拡張** - 設定ファイルだけでなくスクリプトも含む
- **ADR 004更新** - `workloads/` が「設定 + スクリプト」を含むことを記録

**将来の拡張性**:
- `workloads/scripts/` 配下に他のスクリプトも配置可能
- しかし、`.devcontainer/` 関連ツールとの境界が曖昧になる

---

## 6. 解決策の比較表

| 評価基準 | 解決策1: `.devcontainer/dc` | 解決策2: `bin/dc` | 解決策3: `workloads/scripts/dc` |
|---------|---------------------------|-----------------|-------------------------------|
| **v11構造整合性** | ✅ 完全整合（変更なし） | ⚠️ 構造追加が必要 | ⚠️ 構造拡張が必要 |
| **技術的正当性** | ⚠️ DevContainerツールとの混在 | ✅ 開発ツールの標準的配置 | ⚠️ workloads設計意図とズレ |
| **将来の拡張性** | ⚠️ .devcontainer肥大化 | ✅ 統一的なツール管理 | ⚠️ workloads役割の曖昧化 |
| **発見しやすさ** | ⚠️ .devcontainer内を探す必要 | ✅ リポジトリルート直下 | ❌ workloads内を探す必要 |
| **パスの長さ** | `./.devcontainer/dc` (14文字) | `./bin/dc` (8文字) | `./workloads/scripts/dc` (22文字) |
| **保守コスト** | ✅ 低（変更なし） | ⚠️ 中（ADR作成） | ❌ 高（ADR更新、概念変更） |
| **Git管理** | ✅ 既存管理対象 | ✅ 追加で管理 | ✅ 既存管理対象 |

---

## 7. 推奨アプローチ

### 7.1 第一推奨: 解決策2（`bin/` ディレクトリ新設）

**理由**:

1. **技術的正当性が最も高い**
   - `bin/` は開発ツールスクリプトの標準的な配置場所
   - リポジトリ構造の慣習に準拠
   - 役割の明確化（`.devcontainer/` = ビルド用、`bin/` = 運用用）

2. **将来の拡張性**
   - 他の開発ツールを統一的に管理可能
   - `.devcontainer/` の肥大化を防止
   - スケーラブルな構造

3. **発見しやすさ**
   - リポジトリルート直下、パスが短い
   - チームメンバーが直感的に見つけられる

4. **保守コスト vs 長期的利益**
   - ADR作成は1回のみのコスト
   - 長期的には統一された構造により保守性向上

**実装への影響**:
1. v11構造ドキュメント更新（`14_詳細設計_ディレクトリ構成.v11.md`）
2. ADR 005作成: 「開発ツールスクリプトの配置場所」
3. 25_6_16ラッパースクリプト戦略の更新（`bin/dc` への変更）
4. 25_6_12実装トラッカーの更新

### 7.2 第二推奨: 解決策1（`.devcontainer/dc`）

**採用条件**:
- v11構造を変更したくない
- ADR作成のコストを避けたい
- 短期的な実装完了を優先

**理由**:
- v11構造変更なし（最も低リスク）
- 即座に実装可能

**将来的な課題**:
- 他の開発ツール追加時に配置場所の一貫性が失われる可能性
- `.devcontainer/` の役割が曖昧化

---

## 8. 実装計画（解決策2採用時）

### Phase 1: v11構造とADRの更新

**タスク1-1**: ADR 005作成
- **内容**: 「開発ツールスクリプトの配置場所」
- **決定内容**: `bin/` ディレクトリを開発ツール用として定義
- **代替案**: `.devcontainer/`、`workloads/scripts/`
- **選択理由**: 標準的慣習、将来の拡張性、発見しやすさ

**タスク1-2**: v11構造ドキュメント更新
- **ファイル**: `14_詳細設計_ディレクトリ構成.v11.md`
- **更新内容**: `bin/` ディレクトリを追加、説明を記載

### Phase 2: 25_6_16戦略ドキュメントの更新

**タスク2-1**: 25_6_16全体のパス修正
- `bin/dc` → そのまま（既に正しい）
- スクリプト内の相対パス計算の確認

### Phase 3: 実装トラッカーの更新

**タスク3-1**: 25_6_12実装トラッカー更新
- Phase 2-2-1のスクリプト作成タスクに「v11構造整合性確認済み」を追記
- Phase 3にADR作成タスクを追加

---

## 9. 実装計画（解決策1採用時）

### Phase 1: 25_6_16戦略ドキュメントの更新

**タスク1-1**: 25_6_16全体のパス修正
- `bin/dc` → `.devcontainer/dc` に変更
- スクリプト内の相対パス計算を修正（`DEVCONTAINER_DIR="${SCRIPT_DIR}"`）
- 使用例をすべて更新（`./bin/dc` → `./.devcontainer/dc`）

### Phase 2: 実装トラッカーの更新

**タスク2-1**: 25_6_12実装トラッカー更新
- Phase 2-2-1のスクリプト配置場所を `.devcontainer/dc` に変更
- Phase 3-4（README.md）の使用例を更新

---

## 10. 次のアクション

**mode-2（戦略立案モード）の成果物**:
1. ✅ このドキュメント（25_6_17）の作成
2. ⏳ ユーザーへの提示と決定待ち

**ユーザーへの質問**:

以下のいずれかを選択してください:

1. **解決策2（推奨）**: `bin/` ディレクトリを新設
   - v11構造を更新し、ADR 005を作成
   - 長期的な拡張性と保守性を優先

2. **解決策1**: `.devcontainer/dc` に配置
   - v11構造変更なし、ADR不要
   - 短期的な実装完了を優先

3. **解決策3**: `workloads/scripts/dc` に配置
   - 非推奨（workloads設計意図とズレ）

**決定後の次のステップ**:
- 選択された解決策に基づき、mode-3（実装・検証モード）で実装開始

---

**最終更新**: 2026-01-10T06:00:00+09:00
**ステータス**: ✅ 戦略立案完了
**次のアクション**: ユーザーの決定待ち → mode-3で実装開始
