# Monolithic DevContainerの本質 v2

## 課題（目標とのギャップ）

**「開発環境の差異」による開発スループットの低下。**

具体的には：
- 「私の環境では動くんですけど…」問題が頻発する
- 新メンバーのオンボーディングに丸一日かかる
- AIエージェント（Devin、Cursor）が動かすコードと人間が動かすコードで挙動が違う

## 原因

**ローカル開発が前提になっている。**

AIネイティブ時代、Cursorなどのエディタを使いたい。クラウドIDEではなくローカルで動かしたい。しかしローカル開発は、言語ランタイム・ミドルウェア・フレームワークのインストールが各自のOS・パッケージマネージャーに依存する。Homebrewのバージョン、Nodeのバージョン、Pythonの入れ方…すべてがバラバラになる。

さらに、複数プロダクトを横断して開発する場合、「プロダクトAはNode 18、プロダクトBはNode 20」のような状況が生まれ、ローカル環境が複雑化・属人化していく。

## 目的（あるべき状態）

**「環境」を考えなくていい開発体験。**

- 誰が・どのマシンで開発しても、同一の環境で動く
- 複数プロダクトを横断的に、シームレスに開発できる
- 「環境構築」という作業が存在しない（clone → 開発開始）

## 解決のアプローチ（重要な設計判断）

**Monolithic DevContainer = 「すべてをコンテナ上で開発する」**

ここでの重要な設計判断は4つ：

### 1. 「プロジェクトごとのDevContainer」ではなく「組織で1つの巨大なDevContainer」

- プロジェクトごとにDevContainerを持つと、プロジェクトを切り替えるたびにコンテナを立て直す必要がある。横断開発には向かない
- 1つの「全部入り」コンテナに入れば、その中で複数プロダクトを自由に行き来できる

### 2. 「ホストOSにマウント」ではなく「コンテナ内に閉じる」

- ホストとコンテナ間のファイル共有は、OSの差異を持ち込んでしまう（パーミッション、パフォーマンス）
- コンテナ内で完結させることで、「どのホストOSから接続しても同じ」を実現する

### 3. 「環境定義」と「プロダクトコード」の分離

- 環境定義（`${project}-dev-hub`）はチーム共通でGit管理
- プロダクトコードは環境の中に展開される「ゲスト」として扱う
- これにより、環境のバージョンアップとプロダクト開発を独立して進められる

### 4. 「Devin互換性」の確保

**Devin互換性とは何か**

「Devin互換性」とは、汎用AIエージェントであるDevinとの相互運用性を確保することを指します。具体的には以下の2つの要素を含みます：

#### ①物理的配置の互換性

- プロダクトリポジトリが `~/repos/<product-repo>` でアクセス可能であること
- Devinが期待するパス構造を維持すること

#### ②パス参照の安定性（重要）

Devinで実行することを前提としたスクリプトでは、以下の2つのパス記述方法があります：

- **厳密な相対パス**: `cd ../../some-other-repo` のような記述
- **`~/repos/<product-repo>` から始まる絶対パス**: `cd ~/repos/some-other-repo` のような記述

**安定性を求めるなら圧倒的に後者です。**

理由：
- 相対パスは実行場所に依存するため、スクリプトが別の場所から呼ばれると破綻する
- `~/repos/` を基準とする絶対パスなら、どこから実行されても安定して動作する
- CI/CD、タスクランナー、他のAIエージェントとの相互運用性が確保される

**具体例**:

```bash
# 脆弱なパターン（相対パス）
cd ../../product-b
npm run build

# 安定したパターン（~/repos/起点の絶対パス）
cd ~/repos/product-b
npm run build
```

#### ③他AIエージェントとの相互運用性

- Devinが生成したスクリプトを、Cursor、Claude Code等の他のAIエージェントが実行しても動作すること
- 逆に、他のAIエージェントが生成したスクリプトをDevinが実行しても動作すること
- `~/repos/` という共通基準点を設けることで、AIエージェント間の相互運用性を実現

**この設計における実装**:

本設計（v10）では、以下のようにDevin互換性を実現しています：

```
/home/<user>/
├── ${project}-dev-hub/           # バインドマウント
│   └── repos/                    # Docker Volume（直接マウント）
│       ├── product-a/
│       └── product-b/
└── repos -> ${project}-dev-hub/repos/  # Devin互換用シンボリックリンク
```

- 実体: `/home/<user>/${project}-dev-hub/repos/`（I/Oパフォーマンス確保のためDocker Volume上）
- Devin互換パス: `/home/<user>/repos/`（逆向きシンボリックリンク）
- どちらのパスからアクセスしても、同一の実体を参照

**推奨するスクリプト記述パターン**:

すべてのタスクランナー、CI/CD、スクリプトでは以下を推奨します：

```bash
# ✅ 推奨: ~/repos/ 起点の絶対パス
cd ~/repos/product-a && npm run test
cd ~/repos/product-b && npm run build

# ❌ 非推奨: 相対パス（実行場所に依存）
cd ../../product-a && npm run test
```

---

## 変更履歴

### v2 (2026-01-01)
- 「Devin互換性」の定義を明確化
  - 物理的配置の互換性だけでなく、パス参照の安定性まで含む概念として定義
  - スクリプト記述時のベストプラクティスを追加
  - 他AIエージェントとの相互運用性を明記

### v1
- 初版作成
