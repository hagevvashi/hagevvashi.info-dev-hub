# 4. 詳細設計_ディレクトリ構成 v12

## 概要

本設計は、以下の目的を達成するために策定されました：

1. **CLI版AIエージェント（Claude Code CLI、Gemini CLI等）への対応**と**ハイブリッドプロセス管理（supervisord + process-compose）**（v11から継承）
2. **運用ツールスクリプトの配置場所の明確化**（v12で追加）

これにより、以下の5つの要求を同時に満たします：

1. **Devin互換性**: `~/repos/<product-repo>` でアクセス可能（シンボリックリンク経由）
2. **VS Code拡張版コンテキストエンジニアリング**: `workspace.code-workspace` で論理的に統合
3. **CLI版コンテキストエンジニアリング**: 物理的なディレクトリ構造として `foundations/`、`initiatives/`、`repos/` を統一的に参照可能
4. **プロセス管理設定の分離**: ビルド時seed設定（`.devcontainer/`）と実運用project設定（`workloads/`）の2層構造
5. **運用ツールスクリプトの明確な配置場所**: ビルド準備スクリプト（`.devcontainer/`）と運用ツール（`bin/`）の分離（v12で追加）

詳細な設計判断の経緯は以下を参照してください：
- [21_foundations_initiatives_mount_issue.md](21_foundations_initiatives_mount_issue.md) - ディレクトリ構成設計の経緯
- [25_0_process_management_solution.v10.md](25_0_process_management_solution.v10.md) - プロセス管理設計
- [25_6_18_devcontainer_scripts_analysis.md](25_6_18_devcontainer_scripts_analysis.md) - スクリプト分析結果
- [25_6_19_v12_structure_strategy.md](25_6_19_v12_structure_strategy.md) - v12 策定戦略

---

## コンテナ内の全体構造

### `/home/<user>/` 配下の構造

```text
/home/<user>/
├── ${project}-dev-hub/            # バインドマウント（ホストの ${project}-dev-hub リポジトリ）
│   ├── .devcontainer/
│   ├── bin/                       # ★v12で追加: 運用ツールスクリプト
│   ├── foundations/
│   ├── initiatives/
│   ├── members/
│   ├── workloads/                 # ★v11で追加: 実運用プロセス管理設定
│   ├── repos/                     # ★Docker Volume（直接マウント）
│   │   ├── product-a/
│   │   ├── product-b/
│   │   └── ...
│   ├── workspace.code-workspace
│   ├── .gitignore
│   └── .env.example
│
└── repos -> ${project}-dev-hub/repos/  # ★シンボリックリンク（Devin互換用）
```

**重要な設計ポイント：**

1. **物理的な親子関係の逆転**
   - 従来: `repos/` と `${project}-dev-hub` が並列
   - v10-v12: `repos/` が `${project}-dev-hub/` 配下に配置

2. **シンボリックリンクによるDevin互換性の維持**
   - `/home/<user>/repos` → `/home/<user>/${project}-dev-hub/repos` のシンボリックリンク
   - Devinは従来通り `~/repos/<product-repo>` でアクセス可能

3. **CLI版AIエージェントの起動場所**
   - `/home/<user>/${project}-dev-hub` で起動することで、すべてのコンテキスト（`foundations/`、`initiatives/`、`repos/*`、`workloads/`、`bin/`）を参照可能

4. **プロセス管理設定の分離**（v11で追加）
   - ビルド時検証用: `.devcontainer/supervisord/seed.conf`、`.devcontainer/process-compose/seed.yaml`
   - 実運用設定: `workloads/supervisord/project.conf`、`workloads/process-compose/project.yaml`

5. **運用ツールスクリプトの明確な配置**（v12で追加）
   - ビルド準備スクリプト: `.devcontainer/` 配下
   - 運用ツールスクリプト: `bin/` 配下

---

## `${project}-dev-hub/` の詳細構造

```text
${project}-dev-hub/
├── .devcontainer/
│   ├── s6-rc.d/                    # ★v11で追加: s6-overlayサービス定義
│   │   ├── user/contents.d/
│   │   │   ├── docker-entrypoint
│   │   │   ├── supervisord
│   │   │   └── process-compose
│   │   ├── docker-entrypoint/
│   │   │   ├── type                # oneshot
│   │   │   ├── up
│   │   │   └── dependencies.d/base
│   │   ├── supervisord/
│   │   │   ├── type                # longrun
│   │   │   ├── run
│   │   │   └── dependencies.d/docker-entrypoint
│   │   └── process-compose/
│   │       ├── type                # longrun
│   │       ├── run
│   │       └── dependencies.d/docker-entrypoint
│   │
│   ├── supervisord/
│   │   └── seed.conf               # ★v11で変更: ビルド時検証用ダミー設定
│   ├── process-compose/
│   │   └── seed.yaml               # ★v11で変更: ビルド時検証用ダミー設定
│   │
│   ├── devcontainer.json.template  # テンプレートとして管理
│   ├── Dockerfile                  # 全ツールインストール + s6-overlay
│   ├── docker-compose.yml          # s6-overlay対応設定
│   ├── docker-entrypoint.sh        # Phase 4 & 5でworkloads参照
│   ├── debug-entrypoint.sh         # DEBUG_MODE用
│   ├── validate-config.sh          # ホスト側検証
│   ├── setup.sh                    # テンプレート→json生成、.env作成（旧: host-setup.sh）
│   ├── generate-env.sh             # .env生成
│   ├── post-create.sh              # コンテナ内セットアップ
│   └── shell/                      # シェル設定
│
├── bin/                            # ★v12で追加: 運用ツールスクリプト
│   └── dc                          # docker compose exec ラッパー
│
├── foundations/                    # ★確定した土台（Fixed情報）
│   ├── onboarding/                 # 新人向け手順、AI起動方法等
│   │   └── s6-hybrid-process-management-guide.md  # ★v11で追加予定
│   ├── operations/                 # 運用マニュアル
│   ├── adr/                        # Architecture Decision Records
│   │   ├── 001_monolithic-devcontainer.md
│   │   ├── 002_docker-volume-strategy.md
│   │   ├── 003_cli-ai-agent-compatibility.md
│   │   ├── 004_workloads_directory_naming.md
│   │   └── 005_development_tools_scripts_placement.md  # ★v12で追加
│   └── principles/                 # 設計思想、コーディング規約
│
├── initiatives/                    # ★進行中の取り組み（流動的情報）
│   ├── YYYYMMDD-YYYYMMDD--name/    # 完了したinitiative（終了日付入り）
│   ├── YYYYMMDD--name/             # 進行中のinitiative
│   └── ...
│
├── members/                        # 個人の素振り場
│   ├── member-a/
│   │   └── .../                    # 中の構成は自由
│   └── ...
│
├── workloads/                      # ★v11で追加: 実運用プロセス管理設定
│   ├── supervisord/
│   │   ├── project.conf            # 実運用supervisord設定
│   │   └── README.md               # 編集ガイド・使い分け説明
│   └── process-compose/
│       ├── project.yaml            # 実運用process-compose設定
│       └── README.md               # 編集ガイド・使い分け説明
│
├── repos/                          # ★Docker Volume（直接マウント）
│   │                               # ※Git管理対象外
│   ├── product-a/                  # post-create.sh で自動clone
│   ├── product-b/
│   └── ...
│
├── workspace.code-workspace        # VS Code拡張版用のマルチルートワークスペース定義
├── .gitignore                      # repos/, devcontainer.json, .env 等を除外
└── .env.example                    # 必要な環境変数の定義例
```

---

## v12で追加された要素

### 1. `bin/` ディレクトリ - 運用ツールスクリプト

**目的**: DevContainer運用時に開発者が手動で実行するツールスクリプトの配置場所

**配置されるスクリプト**:
- `dc` - docker compose exec ラッパースクリプト

**役割の明確化**:

| ディレクトリ | 役割 | 実行タイミング | 実行場所 | 例 |
|------------|------|--------------|---------|-----|
| `.devcontainer/` | ビルド準備・コンテナ初期化・シェル設定 | DevContainer開く前/中/後 | Host/Container | setup.sh, docker-entrypoint.sh |
| `bin/` | 運用ツール | DevContainer運用中 | Host | dc, test-runner |

**設計意図**:
- `.devcontainer/` と `bin/` の役割を明確に分離
- 将来的な運用ツールの追加に対応（デバッグヘルパー、ログ集約スクリプト、テストランナー等）
- 標準的な慣習（`bin/` ディレクトリ）に準拠

**技術的な正当性**:
- `bin/` は開発ツールスクリプトの標準的な配置場所
- 役割の明確な分離により、保守性が向上
- 発見しやすく、パスが短い（`./bin/dc` = 8文字）

**使用例**:
```bash
# リポジトリルートから
./bin/dc exec dev /bin/bash
# → docker compose -f .devcontainer/docker-compose.yml -f .devcontainer/docker-compose.dev-vm.yml exec -u ${UNAME} dev /bin/bash
```

詳細は [25_6_16_wrapper_script_strategy.md](25_6_16_wrapper_script_strategy.md) を参照してください。

---

## v11で追加された要素（継承）

### 1. `.devcontainer/s6-rc.d/` - s6-overlayサービス定義

**目的**: s6-overlayをPID 1として、supervisordとprocess-composeを管理下に配置

**構成**:
- `user/contents.d/`: 有効化するサービス一覧
- `docker-entrypoint/`: 初期化スクリプト（oneshot）
- `supervisord/`: supervisordサービス定義（longrun）
- `process-compose/`: process-composeサービス定義（longrun）

**設計意図**:
- PID 1をsupervisordから分離することで、supervisord再起動時のコンテナ停止を防止
- supervisordとprocess-composeの並行運用を実現
- 各サービスの依存関係を明示（docker-entrypoint → supervisord/process-compose）

### 2. `workloads/` - 実運用プロセス管理設定

**目的**: ビルド時検証用設定（seed）と実運用設定（project）の分離

**命名の根拠**:
- Kubernetes用語「ワークロード」を採用
- プロセス、サービス、ジョブ、タスクすべてを包含
- 将来的にdocker-composeやK8sの定義も含められる拡張性

**2層構造**:
| 層 | 配置場所 | 目的 | タイミング |
|----|---------|------|-----------|
| seed | `.devcontainer/supervisord/seed.conf` | ビルド時検証用ダミー | ビルド時 |
| seed | `.devcontainer/process-compose/seed.yaml` | ビルド時検証用ダミー | ビルド時 |
| project | `workloads/supervisord/project.conf` | 実運用設定 | 起動時 |
| project | `workloads/process-compose/project.yaml` | 実運用設定 | 起動時 |

**フォールバック機構**:
- `workloads/*/project.*` が存在しない or 無効な場合
- → `.devcontainer/*/seed.*` へ自動フォールバック
- → code-serverのみの最小限環境で起動

### 3. seed設定とproject設定の明確化

**`.devcontainer/supervisord/seed.conf`** (旧: supervisord.conf):
- 最小限のプロセス（code-serverのみ）
- ビルド時の構文検証用
- 実運用では使用しない（フォールバック時のみ）

**`.devcontainer/process-compose/seed.yaml`** (旧: process-compose.yaml):
- プレースホルダープロセスのみ
- ビルド時の構文検証用
- 実運用では使用しない（フォールバック時のみ）

**`workloads/supervisord/project.conf`**:
- code-server、difit等の実運用プロセス
- 開発者が自由に編集可能
- 変更後はsupervisord再起動で反映（s6-svc -t /run/service/supervisord）

**`workloads/process-compose/project.yaml`**:
- 実験的プロセス、ホットリロード対象
- 開発者が自由に編集可能
- 変更後はprocess-compose再起動で反映（s6-svc -t /run/service/process-compose）

---

## 設計判断の記録（ADR）

以下のArchitecture Decision Recordsが本設計の基礎となっています：

| ADR | タイトル | 概要 |
|-----|---------|------|
| 001 | Monolithic DevContainer | 組織で1つの巨大なDevContainerを採用 |
| 002 | Docker Volume Strategy | I/Oパフォーマンスのためのマウント戦略 |
| 003 | CLI AI Agent Compatibility | CLI版AIエージェント対応のための物理統合 |
| 004 | Workloads Directory Naming | `workloads/`命名の根拠とK8s用語の採用 |
| 005 | Development Tools Scripts Placement | 開発ツールスクリプトの配置場所と v12 構造の策定（★v12で追加） |

詳細は `foundations/adr/` を参照してください。

---

## プロセス管理アーキテクチャ

### PID 1とサービス管理

```
PID 1: s6-overlay (init + プロセス監視)
  ├─ s6-svscan (サービススキャナー)
  │   ├─ docker-entrypoint (初期化スクリプト・oneshot)
  │   │   ├─ Phase 1-3: 既存の初期化処理
  │   │   ├─ Phase 4: supervisord 設定検証・シンボリックリンク
  │   │   └─ Phase 5: process-compose 設定検証・シンボリックリンク
  │   │
  │   ├─ supervisord (longrun・常時起動)
  │   │   ├─ [inet_http_server] → Web UI (port 9001)
  │   │   ├─ code-server (必須プロセス)
  │   │   ├─ difit (開発ツール)
  │   │   └─ その他の安定稼働プロセス
  │   │
  │   └─ process-compose (longrun・オプション起動)
  │       ├─ TUI (port 8080 API)
  │       ├─ 実験的プロセス
  │       └─ ホットリロード対象プロセス
  │
  └─ zombie reaping (ゾンビプロセス回収)
```

### サービスの使い分け

| 用途 | 推奨ツール | 理由 |
|------|-----------|------|
| **code-server** | supervisord | 常時起動・Web UIで確認 |
| **difit** | supervisord | 安定稼働・頻繁に起動停止 |
| **vite dev server** | process-compose | ホットリロード・TUIで確認 |
| **実験的サービス** | process-compose | 頻繁な追加削除・YAML編集が楽 |
| **DB（Postgres等）** | supervisord | 安定稼働・依存関係の基盤 |
| **マイクロサービス群** | process-compose | 依存関係定義・まとめて起動停止 |

詳細な使い分けガイドラインは `workloads/supervisord/README.md` および `workloads/process-compose/README.md` を参照してください。

---

## AIエージェントの起動方式（設計意図）

本設計は、AIエージェントの起動方式の違いを考慮しています。

### VS Code拡張版（Cursor、Claude Code拡張等）

**起動方法:**
```bash
# ${project}-dev-hub を VS Code で開き、workspace.code-workspace を開く
code ${project}-dev-hub/workspace.code-workspace
```

**コンテキストエンジニアリング:**
- `workspace.code-workspace` によるマルチルートワークスペース機能で、`foundations/`、`initiatives/`、`repos/*`、`workloads/`、`bin/` を論理的に統合
- 物理的な配置に依存しない

### CLI版（Claude Code CLI、Gemini CLI等）

**起動方法:**
```bash
# コンテナ内で
cd /home/<user>/${project}-dev-hub
claude-code
```

**コンテキストエンジニアリング:**
- 物理的なディレクトリ構造として、`foundations/`、`initiatives/`、`repos/*`、`workloads/`、`bin/` すべてが `${project}-dev-hub/` 配下に存在
- カレントディレクトリ起点で全体を参照可能

**設計意図:**
- CLI版AIエージェントは、起動したカレントディレクトリがワークスペースルートになる制約がある
- `workspace.code-workspace` の恩恵を受けられないため、物理的な統合が必要
- `/home/<user>/${project}-dev-hub` を推奨起動場所とすることで、すべてのコンテキスト（プロセス管理設定、運用ツールを含む）にアクセス可能

詳細な運用手順は `foundations/onboarding/` を参照してください。

---

## 重要な設定ファイル

### `.gitignore`

```gitignore
# DevContainer生成ファイル
devcontainer.json
.env

# プロダクトリポジトリ（Docker Volume管理）
repos/**

# システムファイル
.DS_Store
```

**注意:**
- `repos/**` を除外することで、プロダクトリポジトリが誤ってコミットされるのを防ぐ
- `repos/` 自体もGit管理対象外
- `workloads/` はGit管理対象（実運用設定を共有）
- `bin/` はGit管理対象（運用ツールを共有）

### `workspace.code-workspace`

VS Code拡張版AIエージェント用のマルチルートワークスペース定義ファイル。

**役割:**
- 物理的に分離された（または統合された）ディレクトリを、論理的に1つのワークスペースとして統合
- `foundations/`、`initiatives/`、`repos/*`、`workloads/`、`bin/` を同時に参照可能にする

**v12での変更:**
- `bin/` をワークスペースルートに追加（推奨）

**詳細:**
- 設定例や仕組みは [98_workspace_code-workspaceの仕組み.md](98_workspace_code-workspaceの仕組み.md) を参照
- プロダクトリポジトリが追加される際は、`workspace.code-workspace` と `post-create.sh` の両方を更新

### `devcontainer.json.template`

コンテナ設定のテンプレートファイル。

**主な設定:**
```json
{
  "mounts": [
    "source=${localWorkspaceFolder},target=/home/<user>/${project}-dev-hub,type=bind,consistency=cached",
    "source=repos,target=/home/<user>/${project}-dev-hub/repos,type=volume"
  ],
  "workspaceFolder": "/home/<user>/${project}-dev-hub"
}
```

**重要ポイント:**
1. `${project}-dev-hub` をバインドマウント（Git管理と編集性）
   - `workloads/`、`bin/` も自動的に含まれる
2. `repos/` を `${project}-dev-hub/repos/` に直接Docker Volumeマウント（I/Oパフォーマンス）
3. `workspaceFolder` を `/home/<user>/${project}-dev-hub` に設定

実際の `devcontainer.json` は `setup.sh` により、UID/GID等を注入して生成されます。

### `post-create.sh`

コンテナ作成後に実行されるセットアップスクリプト。

**主な処理:**
1. プロダクトリポジトリの自動clone（`/home/<user>/${project}-dev-hub/repos/` 配下）
2. Devin互換用シンボリックリンクの作成（`/home/<user>/repos` → `${project}-dev-hub/repos`）
3. workloads/ ディレクトリの初期化
4. その他の初期設定

---

## マウント構成の詳細

### マウントポイント一覧

| パス | タイプ | 目的 |
|------|--------|------|
| `/home/<user>/${project}-dev-hub` | バインドマウント | Git管理と編集性。ホストの `${project}-dev-hub` リポジトリ（workloads/、bin/ を含む） |
| `/home/<user>/${project}-dev-hub/repos` | Docker Volume | I/Oパフォーマンス。プロダクトリポジトリ群 |
| `/home/<user>/.ssh` | バインドマウント | 認証情報（SSH鍵） |
| `/home/<user>/.gitconfig` | バインドマウント | Git設定 |

### シンボリックリンク

| リンク元 | リンク先 | 目的 |
|---------|---------|------|
| `/home/<user>/repos` | `/home/<user>/${project}-dev-hub/repos` | Devin互換性の維持 |
| `/etc/supervisor/supervisord.conf` | `workloads/supervisord/project.conf` or `seed.conf` | supervisord設定（実行時に決定） |
| `/etc/process-compose/process-compose.yaml` | `workloads/process-compose/project.yaml` or `seed.yaml` | process-compose設定（実行時に決定） |

**設計意図:**
- `repos/` の実体は `/home/<user>/${project}-dev-hub/repos`（Docker Volume）
- Devinは `/home/<user>/repos` でアクセス（シンボリックリンク経由）
- CLI版AIエージェントは `/home/<user>/${project}-dev-hub/repos` でアクセス（直接）
- supervisord/process-composeの設定は実行時にworkloads/またはseedへシンボリックリンク
- すべてのアクセスパスが適切な実体を指す

---

## 参考資料

- [21_foundations_initiatives_mount_issue.md](21_foundations_initiatives_mount_issue.md): マウント問題の整理と解決策の比較
- [25_0_process_management_solution.v10.md](25_0_process_management_solution.v10.md): プロセス管理設計（ハイブリッド構成）
- [25_6_18_devcontainer_scripts_analysis.md](25_6_18_devcontainer_scripts_analysis.md): スクリプト分析結果
- [25_6_19_v12_structure_strategy.md](25_6_19_v12_structure_strategy.md): v12 策定戦略
- [98_workspace_code-workspaceの仕組み.md](98_workspace_code-workspaceの仕組み.md): マルチルートワークスペースの詳細
- [99_QA.v5.md](99_QA.v5.md): 設計に関する質疑応答

---

## 変更履歴

### v12 (2026-01-10)
- **運用ツールスクリプトの配置場所の明確化**: `bin/` ディレクトリを追加
- **役割の明確な分離**: `.devcontainer/` と `bin/` の役割を定義
- **ADR 005追加**: 開発ツールスクリプトの配置場所と v12 構造の策定
- **`bin/dc` スクリプト配置**: docker compose exec ラッパースクリプト
- **参考資料更新**: 25_6_18、25_6_19 を追加

### v11 (2026-01-03)
- **プロセス管理設計との統合**: v10プロセス管理設計（25_0_process_management_solution.v10.md）を反映
- **`workloads/` ディレクトリ追加**: 実運用プロセス管理設定の配置場所
- **`.devcontainer/s6-rc.d/` 追加**: s6-overlayサービス定義
- **2層構造の明確化**: seed設定（`.devcontainer/`）とproject設定（`workloads/`）の分離
- **プロセス管理アーキテクチャセクション追加**: PID 1保護とサービス管理の説明
- **ADR 004追加**: `workloads/`命名の根拠を記録
- **シンボリックリンク一覧更新**: プロセス管理設定のシンボリックリンクを追加

### v10 (2026-01-01)
- CLI版AIエージェント対応のため、`repos/` を `${project}-dev-hub/` 配下に物理統合
- Devin互換用シンボリックリンクの追加
- AIエージェントの起動方式に関するセクションを追加
- ADR 003（CLI AI Agent Compatibility）の追加を明記

### v9
- `workspace.code-workspace` の説明を追加
- `initiatives/` の命名規則を明確化
