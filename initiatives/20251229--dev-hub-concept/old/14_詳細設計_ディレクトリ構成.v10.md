# 4. 詳細設計_ディレクトリ構成 v10

## 概要

本設計は、**CLI版AIエージェント（Claude Code CLI、Gemini CLI等）への対応**を目的として、プロダクトリポジトリ（`repos/`）を `${project}-dev-hub` 配下に物理的に統合する構造を採用しています。

これにより、以下の3つの要求を同時に満たします：

1. **Devin互換性**: `~/repos/<product-repo>` でアクセス可能（シンボリックリンク経由）
2. **VS Code拡張版コンテキストエンジニアリング**: `workspace.code-workspace` で論理的に統合
3. **CLI版コンテキストエンジニアリング**: 物理的なディレクトリ構造として `foundations/`、`initiatives/`、`repos/` を統一的に参照可能

詳細な設計判断の経緯は [21_foundations_initiatives_mount_issue.md](21_foundations_initiatives_mount_issue.md) を参照してください。

---

## コンテナ内の全体構造

### `/home/<user>/` 配下の構造

```text
/home/<user>/
├── ${project}-dev-hub/            # バインドマウント（ホストの ${project}-dev-hub リポジトリ）
│   ├── .devcontainer/
│   ├── foundations/
│   ├── initiatives/
│   ├── members/
│   ├── repos/                     # ★Docker Volume（直接マウント）
│   │   ├── product-a/
│   │   ├── product-b/
│   │   └── ...
│   ├── workspace.code-workspace
│   ├── .gitignore
│   └── .env.example
│
└── repos -> ${project}-dev-hub/repos/  # ★シンボリックリンク（Devin互換用）
```

**重要な設計ポイント：**

1. **物理的な親子関係の逆転**
   - 従来: `repos/` と `${project}-dev-hub` が並列
   - v10: `repos/` が `${project}-dev-hub/` 配下に配置

2. **シンボリックリンクによるDevin互換性の維持**
   - `/home/<user>/repos` → `/home/<user>/${project}-dev-hub/repos` のシンボリックリンク
   - Devinは従来通り `~/repos/<product-repo>` でアクセス可能

3. **CLI版AIエージェントの起動場所**
   - `/home/<user>/${project}-dev-hub` で起動することで、すべてのコンテキスト（`foundations/`、`initiatives/`、`repos/*`）を参照可能

---

## `${project}-dev-hub/` の詳細構造

```text
${project}-dev-hub/
├── .devcontainer/
│   ├── devcontainer.json.template # ★テンプレートとして管理
│   ├── Dockerfile                 # 全ツールインストール
│   ├── host-setup.sh              # テンプレート→json生成、.env作成
│   └── post-create.sh             # コンテナ内セットアップ（clone + シンボリックリンク作成）
│
├── foundations/                   # ★確定した土台（Fixed情報）
│   ├── onboarding/                # 新人向け手順、AI起動方法等
│   ├── operations/                # 運用マニュアル
│   ├── adr/                       # Architecture Decision Records
│   │   ├── 001_monolithic-devcontainer.md
│   │   ├── 002_docker-volume-strategy.md
│   │   └── 003_cli-ai-agent-compatibility.md  # ★新規（作成予定）
│   └── principles/                # 設計思想、コーディング規約
│
├── initiatives/                   # ★進行中の取り組み（流動的情報）
│   ├── YYYYMMDD-YYYYMMDD--name/   # 完了したinitiative（終了日付入り）
│   ├── YYYYMMDD--name/            # 進行中のinitiative
│   └── ...
│
├── members/                       # 個人の素振り場
│   ├── member-a/
│   │   └── .../                   # 中の構成は自由
│   └── ...
│
├── repos/                         # ★Docker Volume（直接マウント）
│   │                              # ※Git管理対象外
│   ├── product-a/                 # post-create.sh で自動clone
│   ├── product-b/
│   └── ...
│
├── workspace.code-workspace       # VS Code拡張版用のマルチルートワークスペース定義
├── .gitignore                     # repos/, devcontainer.json, .env 等を除外
└── .env.example                   # 必要な環境変数の定義例
```

---

## 設計判断の記録（ADR）

以下のArchitecture Decision Recordsが本設計の基礎となっています：

| ADR | タイトル | 概要 |
|-----|---------|------|
| 001 | Monolithic DevContainer | 組織で1つの巨大なDevContainerを採用 |
| 002 | Docker Volume Strategy | I/Oパフォーマンスのためのマウント戦略 |
| 003 | CLI AI Agent Compatibility | CLI版AIエージェント対応のための物理統合（★作成予定） |

詳細は `foundations/adr/` を参照してください。

---

## AIエージェントの起動方式（設計意図）

本設計は、AIエージェントの起動方式の違いを考慮しています。

### VS Code拡張版（Cursor、Claude Code拡張等）

**起動方法:**
```bash
# ${project}-dev-hub を VS Code で開き、workspace.code-workspace を開く
code ${project}-dev-hub/workspace.code-workspace
```

**コンテキストエンジニアリング:**
- `workspace.code-workspace` によるマルチルートワークスペース機能で、`foundations/`、`initiatives/`、`repos/*` を論理的に統合
- 物理的な配置に依存しない

### CLI版（Claude Code CLI、Gemini CLI等）

**起動方法:**
```bash
# コンテナ内で
cd /home/<user>/${project}-dev-hub
claude-code
```

**コンテキストエンジニアリング:**
- 物理的なディレクトリ構造として、`foundations/`、`initiatives/`、`repos/*` すべてが `${project}-dev-hub/` 配下に存在
- カレントディレクトリ起点で全体を参照可能

**設計意図:**
- CLI版AIエージェントは、起動したカレントディレクトリがワークスペースルートになる制約がある
- `workspace.code-workspace` の恩恵を受けられないため、物理的な統合が必要
- `/home/<user>/${project}-dev-hub` を推奨起動場所とすることで、すべてのコンテキストにアクセス可能

詳細な運用手順は `foundations/onboarding/` を参照してください。

---

## 重要な設定ファイル

### `.gitignore`

```gitignore
# DevContainer生成ファイル
devcontainer.json
.env

# プロダクトリポジトリ（Docker Volume管理）
repos/**

# システムファイル
.DS_Store
```

**注意:**
- `repos/**` を除外することで、プロダクトリポジトリが誤ってコミットされるのを防ぐ
- `repos/` 自体もGit管理対象外

### `workspace.code-workspace`

VS Code拡張版AIエージェント用のマルチルートワークスペース定義ファイル。

**役割:**
- 物理的に分離された（または統合された）ディレクトリを、論理的に1つのワークスペースとして統合
- `foundations/`、`initiatives/`、`repos/*` を同時に参照可能にする

**詳細:**
- 設定例や仕組みは [98_workspace_code-workspaceの仕組み.md](98_workspace_code-workspaceの仕組み.md) を参照
- プロダクトリポジトリが追加される際は、`workspace.code-workspace` と `post-create.sh` の両方を更新

### `devcontainer.json.template`

コンテナ設定のテンプレートファイル。

**主な設定:**
```json
{
  "mounts": [
    "source=${localWorkspaceFolder},target=/home/<user>/${project}-dev-hub,type=bind,consistency=cached",
    "source=repos,target=/home/<user>/${project}-dev-hub/repos,type=volume"
  ],
  "workspaceFolder": "/home/<user>/${project}-dev-hub"
}
```

**重要ポイント:**
1. `${project}-dev-hub` をバインドマウント（Git管理と編集性）
2. `repos/` を `${project}-dev-hub/repos/` に直接Docker Volumeマウント（I/Oパフォーマンス）
3. `workspaceFolder` を `/home/<user>/${project}-dev-hub` に設定

実際の `devcontainer.json` は `host-setup.sh` により、UID/GID等を注入して生成されます。

### `post-create.sh`

コンテナ作成後に実行されるセットアップスクリプト。

**主な処理:**
1. プロダクトリポジトリの自動clone（`/home/<user>/${project}-dev-hub/repos/` 配下）
2. Devin互換用シンボリックリンクの作成（`/home/<user>/repos` → `${project}-dev-hub/repos`）
3. その他の初期設定

---

## マウント構成の詳細

### マウントポイント一覧

| パス | タイプ | 目的 |
|------|--------|------|
| `/home/<user>/${project}-dev-hub` | バインドマウント | Git管理と編集性。ホストの `${project}-dev-hub` リポジトリ |
| `/home/<user>/${project}-dev-hub/repos` | Docker Volume | I/Oパフォーマンス。プロダクトリポジトリ群 |
| `/home/<user>/.ssh` | バインドマウント | 認証情報（SSH鍵） |
| `/home/<user>/.gitconfig` | バインドマウント | Git設定 |

### シンボリックリンク

| リンク元 | リンク先 | 目的 |
|---------|---------|------|
| `/home/<user>/repos` | `/home/<user>/${project}-dev-hub/repos` | Devin互換性の維持 |

**設計意図:**
- `repos/` の実体は `/home/<user>/${project}-dev-hub/repos`（Docker Volume）
- Devinは `/home/<user>/repos` でアクセス（シンボリックリンク経由）
- CLI版AIエージェントは `/home/<user>/${project}-dev-hub/repos` でアクセス（直接）
- すべてのアクセスパスが同一の実体を指す

---

## 参考資料

- [21_foundations_initiatives_mount_issue.md](21_foundations_initiatives_mount_issue.md): マウント問題の整理と解決策の比較
- [98_workspace_code-workspaceの仕組み.md](98_workspace_code-workspaceの仕組み.md): マルチルートワークスペースの詳細
- [99_QA.v5.md](99_QA.v5.md): 設計に関する質疑応答

---

## 変更履歴

### v10 (2026-01-01)
- CLI版AIエージェント対応のため、`repos/` を `${project}-dev-hub/` 配下に物理統合
- Devin互換用シンボリックリンクの追加
- AIエージェントの起動方式に関するセクションを追加
- ADR 003（CLI AI Agent Compatibility）の追加予定を明記

### v9
- `workspace.code-workspace` の説明を追加
- `initiatives/` の命名規則を明確化
