# s6-overlay起動失敗：tmpfs競合問題の調査・解決策立案 (改訂版)

**作成日**: 2026-01-03
**最終更新日**: 2026-01-03
**関連ログ**:
- `initiatives/20251229--dev-hub-concept/202601032048-devcontainer-output.log`
- `initiatives/20251229--dev-hub-concept/202601032048-devcontainer-terminal.log`

## 1. 目標（本来の要求と気づいてなかった要求）

Monolithic DevContainerの起動に失敗せず、`s6-overlay`が正常にPID 1として機能し、コンテナのプロセス管理基盤となることです。
当初の目標に加え、**Dockerの`tmpfs`マウントが持つデフォルトのセキュリティ制約（`noexec`オプション）を理解し、その上で`tmpfs`の利点を最大限に活かしつつ、実行ファイルが正常に動作する堅牢な開発環境を構築すること**が、今回新たに明確になった要求です。

## 2. 課題

Monolithic DevContainerの起動に失敗し、`s6-overlay`がその初期化プロセスを実行できません。これにより、PID 1保護と堅牢なプロセス管理が実現できておらず、開発環境の安定性が損なわれています。

## 3. 原因

### Claude Codeによる診断結果と追加調査（Gemini）

1.  **問題**: `s6-overlay`の `/run/s6/basedir/bin/init` に対する権限エラー（Permission denied）が発生し、`s6-overlay` の初期化に失敗していました。
2.  **根本原因**:
    -   `docker-compose.yml` で `tmpfs` マウントが `/run` ディレクトリ全体に適用されていました。
    -   Dockerの`tmpfs`マウントは、デフォルトで**`noexec`オプション**が有効になっています。
    -   `s6-overlay` は `/run/s6/` 配下に実行ファイル（バイナリ）を配置しますが、`noexec` オプションが有効なファイルシステム上では、これらの実行ファイルが**実行を拒否**されていたため、`s6-overlay` の初期化プロセスが完了できませんでした。

## 4. 目的（あるべき状態）

-   `s6-overlay` が正常にPID 1として機能し、コンテナのプロセス管理基盤となること。
-   `supervisord` および `process-compose` が `s6-overlay` の管理下で正しく起動すること。
-   開発環境の堅牢性と耐障害性を維持すること。
-   `tmpfs` の高速性・揮発性という利点を活用しつつ、`s6-overlay` の実行ファイルが問題なく動作するよう、`tmpfs` マウントの設定を最適化すること。

## 5. 解決のアプローチ

`s6-overlay` の実行ファイルを許可するために、`tmpfs` マウントに `exec` オプションを明示的に追加します。これにより、`tmpfs` の利点を維持しつつ、`s6-overlay` の正常な動作を確保します。

## 6. 解決策（少なくとも3つの異なる、比較可能な解決策）

### 解決策1: `/run:exec` オプション付きで `tmpfs` マウントする（推奨・解決済み）

-   **概要**: `docker-compose.yml` の `tmpfs` 設定において、`/run` ディレクトリを `exec` オプション付きでマウントします。
-   **具体的な修正**:
    ```yaml
    services:
      dev:
        # ... 既存の設定 ...
        tmpfs:
          - /run:exec     # ★ここに :exec オプションを追加 ★
          - /run/lock
          - /tmp
        # ... 他の設定 ...
    ```
-   **メリット**:
    -   `s6-overlay` が `/run/s6/` 配下に配置する実行ファイルを、`tmpfs` 上で正常に実行できるようになります。
    -   `/run` が `tmpfs` であることの利点（メモリベースの高速I/O、コンテナ停止時のデータ破棄）を維持できます。
    -   最も直接的に問題（`noexec`による実行拒否）を解決し、コンテナの起動を正常化します。
    -   実装が非常に簡単です。
-   **デメリット**: 特になし。`tmpfs` の利点を活かしつつ問題を解決できるため、この問題に対する最適な解決策です。
-   **比較**: この解決策により問題が既に解決しているため、最も推奨されます。

### 解決策2: `tmpfs`から`/run`を完全に削除する（次善策）

-   **概要**: `docker-compose.yml` の `tmpfs` 設定から `/run` を完全に削除し、`/run` ディレクトリは通常のファイルシステムの一部として扱われるようにします。
-   **メリット**:
    -   `s6-overlay` が `/run/s6/` に自由にファイルを配置できるようになるため、競合（`noexec` による実行拒否含む）が確実に解消されます。
    -   実装が簡単です。
-   **デメリット**: `/run` が `tmpfs` でなくなることによる潜在的な副作用（ディスクI/Oの発生、コンテナ再起動時の永続性など）があります。`tmpfs` の高速性・揮発性という利点を一部放棄することになります。
-   **比較**: 解決策1が機能しない場合の代替案として検討されますが、`tmpfs` の利点を失うため推奨度は下がります。

### 解決策3: `s6-overlay`のベースディレクトリを変更する（最終手段）

-   **概要**: `s6-overlay` がそのランタイムファイルを配置するベースディレクトリ（デフォルトは `/run/s6/`）を、`/var/s6/` など `tmpfs` や `noexec` と競合しない別の場所に変更できないか調査します。
-   **メリット**: `s6-overlay` の `/run` に対する依存性を完全に切り離せます。
-   **デメリット**: `s6-overlay` の内部動作に関する深い知識が必要であり、公式ドキュメントでのサポートが薄い可能性が高いです。設定変更が複雑で、予期せぬ副作用のリスクが高いため、推奨されません。
-   **比較**: 解決策1や2が失敗した場合の最終手段として検討すべき、高度な解決策です。

## 7. 推奨解決策

**解決策1: `/run:exec` オプション付きで `tmpfs` マウントする** を推奨します。
この解決策は実際に問題が解決した実績があり、`tmpfs` の利点を維持しつつ、`s6-overlay` の正常動作を確保できる最適なアプローチです。

## 8. 実装計画

1.  **`docker-compose.yml` の修正**:
    -   `.devcontainer/docker-compose.yml` を開きます。
    -   `services.dev.tmpfs` セクションの `/run` エントリを `/run:exec` に修正します。
    -   **修正例**:
        ```yaml
        services:
          dev:
            # ... 既存の設定 ...
            tmpfs:
              - /run:exec     # ★ここに :exec オプションを追加 ★
              - /run/lock
              - /tmp
            # ... 他の設定 ...
        ```

2.  **ビルドの実行**:
    -   `docker compose build --no-cache` を実行して、ビルドが成功することを確認します。

3.  **コンテナの起動と確認**:
    -   `docker compose up -d` を実行して、コンテナが正常に起動することを確認します。
    -   `docker logs <container_name>` でエラーログがないことを確認し、`s6-overlay` および `supervisord` が機能していることを確認します。
    -   `http://localhost:9001` (supervisord Web UI) にアクセスできるか確認します。
    -   `docker ps` でコンテナが `healthy` 状態であることを確認します。

## 9. 学び (Lessons Learned)

-   Dockerの`tmpfs`マウントはデフォルトで`noexec`オプションが有効であるというセキュリティ上の制約を認識しました。( ref. https://zenn.dev/dqneo/articles/5838037f67f39f )
-   `s6-overlay`のようなプロセス管理ツールが`tmpfs`上に実行ファイルを配置する場合、明示的に`exec`オプションを付与することが不可欠です。
-   `tmpfs`の利点（高速性、揮発性）を享受しつつ、実行ファイルの実行を許可する適切な設定を学びました。
